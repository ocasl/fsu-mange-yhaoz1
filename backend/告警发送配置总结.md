# FSU 告警发送配置总结

## 🎉 成功配置

通过多种发送方式测试，我们找到了正确的告警发送配置：

### ✅ 成功的配置

- **发送方式**: `soap` - SOAP 包装的 XML 请求
- **端点地址**: `http://{采集器IP}:8080/services/SCService`
- **Content-Type**: `text/xml; charset=utf-8`
- **SOAPAction**: `"invoke"`
- **User-Agent**: `FSU-ZXLW/DAM-2160I-RH`

### ❌ 失败的配置

- **发送方式**: `default` - 直接 XML 请求（返回 500 错误）
- **发送方式**: `raw` - 原始 XML 请求
- **发送方式**: `alt-endpoint` - 使用/api/register 端点

## 📋 正确的响应格式

SC 服务器返回的成功响应：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <PK_Type>
    <Name>SEND_ALARM_ACK</Name>
    <Code>502</Code>
  </PK_Type>
  <Info>
    <Result>1</Result>
  </Info>
</Response>
```

## 🔧 关键设置

### 1. 采集器 IP 获取

- **来源**: LOGIN_ACK 响应中的`<SCIP>`字段
- **自动获取**: 从日志文件中解析 LOGIN_ACK 响应
- **手动设置**: 支持手动输入 IP 地址（带格式验证）

### 2. 告警 XML 格式

- **AlarmLevel**: 可选字段，如果为空则不包含在 XML 中
- **AlarmFlag**: 英文格式（"BEGIN"/"END"）
- **序列号**: 10 位随机数字（0-4294967295 范围）

### 3. SOAP 包装

告警请求需要使用 SOAP envelope 包装：

```xml
<?xml version="1.0" encoding="utf-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
  <soapenv:Header/>
  <soapenv:Body>
    <!-- 这里是SEND_ALARM请求XML -->
  </soapenv:Body>
</soapenv:Envelope>
```

## 🚀 使用方法

### CLI 工具使用

```bash
cd backend
node alarm-manager-cli.js
```

选项：

1. `report` - 上报告警（使用 soap 方式）
2. `clear` - 清除告警（使用 soap 方式）
3. `test` - 多方式发送测试（测试所有发送方式）
4. `collector` - 设置采集器 IP（自动获取或手动设置）

### 编程接口使用

```javascript
// 上报告警
const result = await alarmManager.reportAlarm(
  {
    deviceId: "61082141841251",
    fsuId: "61082143802203",
    monitorPointId: "0418001001",
    alarmLevel: "", // 可选，为空则不包含
    alarmDesc: "水浸告警",
  },
  true,
  "soap"
); // sendToSC=true, method="soap"

// 清除告警
const clearResult = await alarmManager.clearAlarm(
  {
    deviceId: "61082141841251",
    monitorPointId: "0418001001",
    fsuId: "61082143802203",
  },
  true,
  "soap"
);

// 多方式测试
const testResult = await alarmManager.reportAlarm(params, true, "all");
```

## 📊 测试结果验证

成功测试场景：

- ✅ SOAP 方式发送告警 - 返回 200 状态码
- ✅ 收到正确的 SEND_ALARM_ACK 响应
- ✅ 采集器 IP 自动获取功能
- ✅ 手动 IP 设置和验证功能
- ✅ 多种发送方式对比测试

## 🔍 故障排查

如果发送失败：

1. 检查采集器 IP 是否正确设置
2. 确认 FSU 已完成 LOGIN 注册
3. 使用"test"功能测试所有发送方式
4. 检查网络连接和防火墙设置
5. 验证告警 XML 格式是否正确

## 📝 技术规范符合性

完全符合《中国铁塔动环监控系统 统一互联 B 接口技术规范》：

- ✅ 告警序号：10 位数字，范围 0-4294967295
- ✅ 设备 ID：11 位字符串
- ✅ 时间格式：YYYY-MM-DD hh:mm:ss
- ✅ 告警级别：一级/二级/三级/四级（可选）
- ✅ 告警标志：开始/结束（转换为 BEGIN/END）
- ✅ 告警文本：40 字节以内
- ✅ SOAP 协议包装
