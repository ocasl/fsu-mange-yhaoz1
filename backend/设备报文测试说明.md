# 设备报文测试系统

这是一个完整的 FSU 设备报文测试系统，支持您提供的所有设备类型的 GET_DATA 请求和响应。

## 支持的设备类型

| 设备类型       | FSU ID         | 设备 ID        | 描述         |
| -------------- | -------------- | -------------- | ------------ |
| flooding       | 61080243800281 | 61080241840279 | 水浸传感器   |
| temperature    | 61080243800281 | 61080241830309 | 温湿度传感器 |
| switchPower    | 61080243800281 | 61080240600278 | 开关电源     |
| battery        | 61089443800204 | 61089440700375 | 蓄电池       |
| smoke          | 61089443800204 | 61089441820181 | 烟雾传感器   |
| infrared       | 61089443800204 | 61089441810120 | 红外传感器   |
| doorAccess     | 61089443800204 | 61089449900035 | 非智能门禁   |
| stepBattery    | 61089443800204 | 61089444700207 | 梯次电池     |
| airConditioner | 61080243801859 | 61080241501046 | 空调         |

## 系统特性

1. **完整的 SOAP 协议支持** - 处理 SC 服务器发送的标准 GET_DATA 请求
2. **真实数据模拟** - 基于您提供的真实报文生成虚拟数据
3. **动态数据更新** - 每 30 秒自动刷新设备数据，模拟真实传感器
4. **多设备支持** - 支持 9 种不同类型的设备
5. **完整测试工具** - 提供自动化测试和压力测试功能

## 快速开始

### 1. 启动设备测试系统

```bash
# 启动FSU WebService服务器
npm run start:device-system

# 或者直接运行
node start-device-test-system.js
```

系统启动后会显示：

- 支持的设备类型列表
- WebService 服务地址
- 使用说明和测试命令

### 2. 测试所有设备

```bash
# 测试所有设备类型
npm run test:devices

# 或者直接运行
node test-device-messages.js all
```

### 3. 测试特定设备

```bash
# 测试水浸传感器
node test-device-messages.js device flooding

# 测试温湿度传感器
node test-device-messages.js device temperature

# 测试开关电源
node test-device-messages.js device switchPower
```

### 4. 查看支持的设备列表

```bash
npm run test:list
```

### 5. 压力测试

```bash
# 对水浸传感器进行20次请求的压力测试，间隔1秒
node test-device-messages.js stress flooding 20 1000
```

### 6. 实时日志监控

```bash
# 实时监控请求和响应日志
npm run logs

# 查看最近的日志条目
npm run logs:tail

# 清空日志文件
npm run logs:clear
```

## 服务端点

启动系统后可以访问以下端点：

- **WebService 端点**: `http://localhost:8080/services/FSUService`
- **健康检查**: `http://localhost:8080/health`
- **服务状态**: `http://localhost:8080/`

## GET_DATA 请求格式

SC 服务器发送的标准 SOAP 请求格式：

```xml
<?xml version="1.0" encoding="utf-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Body>
        <ns1:invoke xmlns:ns1="http://webservice/">
            <ns1:xmlStr><![CDATA[
                <?xml version="1.0" encoding="UTF-8"?>
                <Request>
                    <PK_Type>
                        <Name>GET_DATA</Name>
                        <Code>401</Code>
                    </PK_Type>
                    <Info>
                        <FsuId>61080243800281</FsuId>
                        <FsuCode>61080243800281</FsuCode>
                        <DeviceList>
                            <Device Id="61080241840279" Code="61080241840279">
                                <Id>9999999999</Id>
                            </Device>
                        </DeviceList>
                    </Info>
                </Request>
            ]]></ns1:xmlStr>
        </ns1:invoke>
    </soapenv:Body>
</soapenv:Envelope>
```

## 响应格式示例

### 水浸传感器响应

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <PK_Type>
        <Name>GET_DATA_ACK</Name>
        <Code>402</Code>
    </PK_Type>
    <Info>
        <FsuId>61080243800281</FsuId>
        <FsuCode>61080243800281</FsuCode>
        <Result>1</Result>
        <Values>
            <DeviceList>
                <Device Id="61080241840279" Code="61080241840279">
                    <TSemaphore Type="2" Id="0418001001" SetupVal="0" Status="0" MeasuredVal="0"/>
                </Device>
            </DeviceList>
        </Values>
    </Info>
</Response>
```

### 温湿度传感器响应

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <PK_Type>
        <Name>GET_DATA_ACK</Name>
        <Code>402</Code>
    </PK_Type>
    <Info>
        <FsuId>61080243800281</FsuId>
        <FsuCode>61080243800281</FsuCode>
        <Result>1</Result>
        <Values>
            <DeviceList>
                <Device Id="61080241830309" Code="61080241830309">
                    <TSemaphore Type="2" Id="0418004001" SetupVal="0" Status="0" MeasuredVal="0"/>
                    <TSemaphore Type="2" Id="0418005001" SetupVal="0" Status="0" MeasuredVal="0"/>
                    <TSemaphore Type="2" Id="0418006001" SetupVal="0" Status="0" MeasuredVal="0"/>
                    <TSemaphore Type="2" Id="0418007001" SetupVal="0" Status="0" MeasuredVal="0"/>
                    <TSemaphore Type="2" Id="0418008001" SetupVal="0" Status="0" MeasuredVal="0"/>
                    <TSemaphore Type="3" Id="0418101001" SetupVal="0" Status="0" MeasuredVal="26.234567"/>
                    <TSemaphore Type="3" Id="0418102001" SetupVal="0" Status="0" MeasuredVal="58.123456"/>
                </Device>
            </DeviceList>
        </Values>
    </Info>
</Response>
```

## 数据特性

### 虚拟数据生成

系统为每种设备类型生成符合实际情况的虚拟数据：

- **温湿度传感器**: 温度 15-35°C，湿度 30-80%
- **开关电源**: 电压 210-230V，频率 49-51Hz
- **蓄电池**: 电压 48-56V
- **水浸/烟雾/红外**: 随机告警状态
- **门禁**: 随机开关状态
- **梯次电池**: 复杂的电池组数据
- **空调**: 温度控制数据

### 数据刷新

- 每 30 秒自动刷新所有设备的虚拟数据
- 模拟真实传感器的数据变化
- 保持数据的合理性和一致性

## 测试报告

运行完整测试后，系统会生成详细的测试报告：

- 总测试数和成功率
- 每个设备的详细测试结果
- 响应时间统计
- 完整的响应数据
- 保存为 JSON 格式便于分析

测试报告保存位置：`./logs/device-test-report.json`

## 高级用法

### 自定义端口和 FSU ID

```bash
# 使用自定义端口
node start-device-test-system.js --port 8090

# 使用自定义FSU ID
node start-device-test-system.js --fsu-id 61089443800204

# 组合使用
node start-device-test-system.js --port 8090 --fsu-id 61089443800204
```

### 使用 curl 测试

```bash
# 测试水浸传感器
curl -X POST http://localhost:8080/services/FSUService \
  -H "Content-Type: text/xml; charset=utf-8" \
  -H 'SOAPAction: "invoke"' \
  -d '<?xml version="1.0" encoding="utf-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
    <soapenv:Body>
        <ns1:invoke xmlns:ns1="http://webservice/">
            <ns1:xmlStr><![CDATA[<?xml version="1.0" encoding="UTF-8"?><Request><PK_Type><Name>GET_DATA</Name><Code>401</Code></PK_Type><Info><FsuId>61080243800281</FsuId><FsuCode>61080243800281</FsuCode><DeviceList><Device Id="61080241840279" Code="61080241840279"><Id>9999999999</Id></Device></DeviceList></Info></Request>]]></ns1:xmlStr>
        </ns1:invoke>
    </soapenv:Body>
</soapenv:Envelope>'
```

## 故障排除

### 常见问题

1. **端口被占用**

   ```bash
   # 检查端口占用
   netstat -an | findstr :8080

   # 使用其他端口启动
   node start-device-test-system.js --port 8090
   ```

2. **测试连接失败**

   - 确保 FSU WebService 服务器已启动
   - 检查防火墙设置
   - 验证服务地址是否正确

3. **设备 ID 不匹配**
   - 检查请求中的 FSU ID 和设备 ID 是否正确
   - 参考支持的设备列表

### 日志查看

系统提供了强大的日志功能，方便您查看所有请求和响应：

#### 实时日志监控

```bash
# 启动实时日志监控（推荐）
npm run logs

# 或者直接运行
node log-viewer.js watch
```

实时监控会显示：

- 🔵 GET_DATA 请求详情
- ✅ GET_DATA_ACK 响应详情
- 💓 心跳请求处理过程
- 💚 心跳响应结果
- 🔧 设备数据生成过程

#### 查看历史日志

```bash
# 查看最近20条重要日志
npm run logs:tail

# 查看最近50条日志
node log-viewer.js tail 50
```

#### 日志文件位置

系统日志保存在 `./logs/` 目录下：

- `combined.log` - 完整日志（包含详细的请求/响应 XML）
- `error.log` - 错误日志
- `device-test-report.json` - 测试报告

#### 日志内容示例

启动日志监控后，当 SC 服务器发送请求时，您会看到类似这样的输出：

```
🔵 [2024-01-20 14:30:15] GET_DATA请求
   FSU ID: 61080243800281
   设备: [{"id":"61080241840279","code":"61080241840279"}]

✅ [2024-01-20 14:30:15] GET_DATA_ACK响应
   FSU ID: 61080243800281
   设备ID: 61080241840279
   结果: 成功
```

## 集成说明

这个系统完全兼容您现有的 FSU 心跳保活系统，可以：

1. **独立运行** - 作为独立的设备数据服务器
2. **集成运行** - 与现有心跳系统集成
3. **扩展使用** - 添加更多设备类型和数据格式

系统设计遵循中国铁塔动环监控系统 B 接口技术规范，确保与实际 SC 服务器的兼容性。
