# FSU 设备报文测试系统 - 快速使用指南

## 🚀 一键启动

### 第一步：启动 FSU 服务器

```bash
cd backend
npm run start:device-system
```

您会看到：

```
🚀 [系统启动] FSU WebService服务器已启动
📍 FSU ID: 61080243800281
🌐 服务端口: 8080
📡 等待SC服务器的请求...
```

### 第二步：启动日志监控（新窗口）

```bash
cd backend
npm run logs
```

您会看到：

```
📊 启动FSU日志监控器
📂 日志文件: ./logs/combined.log
🔍 监控模式: 实时显示请求/响应
👀 开始监控日志文件...
```

## 📡 工作原理

1. **FSU 服务器等待请求** - 监听端口 8080，等待 SC 服务器发送 GET_DATA 或心跳请求
2. **自动响应** - 根据您提供的报文格式自动生成对应的响应数据
3. **实时日志** - 在日志监控窗口中实时显示每个请求和响应的详细信息

## 🔍 查看请求和响应

当 SC 服务器发送请求时，您会在两个窗口看到：

### FSU 服务器窗口：

```
🔵 [GET_DATA请求] 2024-01-20 14:30:15
📍 FSU ID: 61080243800281
📱 设备列表: [{"id":"61080241840279","code":"61080241840279"}]
📄 原始XML请求:
<?xml version="1.0" encoding="UTF-8"?>
<Request>
  <PK_Type>
    <Name>GET_DATA</Name>
    <Code>401</Code>
  </PK_Type>
  ...
</Request>

✅ [GET_DATA_ACK响应] 2024-01-20 14:30:15
📍 FSU ID: 61080243800281
📱 设备ID: 61080241840279
📄 响应XML:
<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <PK_Type>
    <Name>GET_DATA_ACK</Name>
    <Code>402</Code>
  </PK_Type>
  ...
</Response>
```

### 日志监控窗口：

```
🔵 [2024-01-20 14:30:15] GET_DATA请求
   FSU ID: 61080243800281
   设备: [{"id":"61080241840279","code":"61080241840279"}]

✅ [2024-01-20 14:30:15] GET_DATA_ACK响应
   FSU ID: 61080243800281
   设备ID: 61080241840279
   结果: 成功
```

## 🧪 自己测试系统

如果您想自己测试系统是否正常工作：

### 测试所有设备类型

```bash
npm run test:devices
```

### 测试特定设备

```bash
# 测试水浸传感器
node test-device-messages.js device flooding

# 测试温湿度传感器
node test-device-messages.js device temperature

# 测试开关电源
node test-device-messages.js device switchPower
```

## 📋 支持的设备类型

| 设备类型       | FSU ID         | 设备 ID        | 描述         |
| -------------- | -------------- | -------------- | ------------ |
| flooding       | 61080243800281 | 61080241840279 | 水浸传感器   |
| temperature    | 61080243800281 | 61080241830309 | 温湿度传感器 |
| switchPower    | 61080243800281 | 61080240600278 | 开关电源     |
| battery        | 61089443800204 | 61089440700375 | 蓄电池       |
| smoke          | 61089443800204 | 61089441820181 | 烟雾传感器   |
| infrared       | 61089443800204 | 61089441810120 | 红外传感器   |
| doorAccess     | 61089443800204 | 61089449900035 | 非智能门禁   |
| stepBattery    | 61089443800204 | 61089444700207 | 梯次电池     |
| airConditioner | 61080243801859 | 61080241501046 | 空调         |

## 🛠 SC 服务器连接配置

SC 服务器应该向以下地址发送请求：

- **WebService 端点**: `http://localhost:8080/services/FSUService`
- **内容类型**: `text/xml; charset=utf-8`
- **SOAPAction**: `"invoke"`

## ❓ 常见问题

### Q: 端口被占用怎么办？

```bash
# 使用其他端口启动
node start-device-test-system.js --port 8090
```

### Q: 没有看到日志怎么办？

1. 确保 FSU 服务器已启动
2. 确保日志监控器已启动
3. 检查 SC 服务器是否正确发送请求到 `http://localhost:8080/services/FSUService`

### Q: 设备 ID 不匹配怎么办？

- 请查看上面的设备类型表格，确保 SC 服务器请求的 FSU ID 和设备 ID 是正确的

### Q: 如何停止系统？

- 在任何窗口按 `Ctrl+C` 即可停止对应的服务

## 📞 联系信息

如果您在使用过程中遇到任何问题，请查看：

- 完整文档：`设备报文测试说明.md`
- 日志文件：`./logs/combined.log`
- 错误日志：`./logs/error.log`

---

**🎉 现在您的 FSU 服务器已经准备好接收 SC 服务器的请求了！**
