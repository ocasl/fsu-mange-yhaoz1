# FSU 系统权限控制功能使用指南

## 功能概述

FSU 管理系统现在支持基于角色的权限控制，确保总账号能够监控所有子账号的操作行为，而子账号只能查看和操作自己的数据。

## 权限等级

### 总账号（管理员）

- **角色标识**: `admin`
- **权限范围**:
  - ✅ 查看所有用户的 FSU 上线记录
  - ✅ 查看所有用户的告警记录
  - ✅ 查看所有用户的操作日志
  - ✅ 注册新的子账号
  - ✅ 管理用户状态（启用/禁用/删除）
  - ✅ 查看系统统计数据

### 子账号（普通用户）

- **角色标识**: `user`
- **权限范围**:
  - ✅ 仅查看自己创建的 FSU 上线记录
  - ✅ 仅查看自己创建的告警记录
  - ✅ 仅查看自己的操作日志
  - ❌ 无法注册新用户
  - ❌ 无法查看其他用户的任何数据
  - ❌ 无法管理其他用户

## 页面权限控制

### 1. FSU 上线管理页面

**路径**: `/fsu-online`

**权限控制**:

- 总账号：显示所有用户创建的 FSU 记录
- 子账号：只显示当前用户创建的 FSU 记录
- 页面顶部显示权限提示信息

**实现原理**:

```javascript
// 后端控制器权限过滤
if (req.user && !req.user.isAdmin()) {
  query.creator = req.user.username;
}
```

### 2. 告警报告页面

**路径**: `/alarm-report`

**权限控制**:

- 总账号：显示所有用户的告警记录
- 子账号：只显示当前用户创建的告警记录
- 页面顶部显示权限提示信息

**实现原理**:

```javascript
// 后端控制器权限过滤
if (req.user && !req.user.isAdmin()) {
  query.creator = req.user.username;
}
```

### 3. 操作记录页面

**路径**: `/operation-logs`

**权限控制**:

- 总账号：查看所有用户的操作记录
- 子账号：只查看自己的操作记录

### 4. 用户管理页面

**路径**: `/user-management`

**权限控制**:

- 总账号：可见和使用
- 子账号：不可见（菜单中不显示）

## 测试账号

系统提供了以下测试账号供您验证权限控制功能：

| 账号类型 | 用户名 | 密码   | 说明       |
| -------- | ------ | ------ | ---------- |
| 总账号   | admin  | 123456 | 系统管理员 |
| 子账号   | user1  | 123456 | 测试用户 1 |
| 子账号   | user2  | 123456 | 测试用户 2 |

## 快速测试步骤

### 第一步：创建测试用户

```bash
cd backend
npm run create-test-users
```

### 第二步：启动系统

```bash
# 启动后端
cd backend
npm start

# 启动前端（新终端）
cd frontend
npm start
```

### 第三步：权限测试

#### 测试总账号权限

1. 使用 `admin/123456` 登录
2. 进入"FSU 上线"页面，点击"创建演示 FSU"按钮
3. 进入"告警报告"页面，点击"创建演示告警"按钮
4. 进入"操作记录"页面，查看所有操作记录
5. 进入"用户管理"页面，验证管理员功能

#### 测试子账号权限

1. 使用 `user1/123456` 登录
2. 注意观察页面权限提示信息
3. 进入"FSU 上线"页面，创建一些 FSU 记录
4. 进入"告警报告"页面，创建一些告警记录
5. 确认只能看到自己创建的记录
6. 确认菜单中没有"用户管理"选项

#### 验证权限隔离

1. 重新用 `admin` 登录
2. 查看"FSU 上线"和"告警报告"页面，确认能看到所有用户的记录
3. 查看"操作记录"页面，确认能看到所有用户的操作

## 数据库记录

### FSU 上线记录

每条 FSU 记录包含 `creator` 字段，标识创建者：

```javascript
{
  fsuid: "61080243xxx",
  siteName: "测试站点",
  creator: "user1",  // 创建者用户名
  // ... 其他字段
}
```

### 告警记录

每条告警记录包含 `creator` 字段：

```javascript
{
  fsuid: "61080243xxx",
  alarmDesc: "温度超限",
  creator: "user1",  // 创建者用户名
  // ... 其他字段
}
```

### 操作日志

每条操作日志包含用户信息：

```javascript
{
  userId: ObjectId("..."),
  username: "user1",
  operation: "CREATE_FSU",
  module: "FSU",
  description: "创建FSU设备",
  // ... 其他字段
}
```

## 安全特性

### 1. JWT 令牌认证

- 所有 API 请求都需要携带有效的 JWT 令牌
- 令牌包含用户 ID 和角色信息
- 令牌过期自动跳转到登录页面

### 2. 后端权限验证

- 中间件自动验证用户身份
- 控制器层面进行数据过滤
- 防止前端绕过权限限制

### 3. 前端权限提示

- 页面顶部显示权限范围提示
- 菜单项根据用户角色动态显示
- 操作按钮根据权限控制可见性

## 故障排除

### 问题 1：看不到权限提示

**解决方法**: 确保浏览器 localStorage 中有用户信息，重新登录

### 问题 2：子账号能看到其他用户数据

**解决方法**: 检查后端中间件是否正确应用，确认 JWT 令牌有效

### 问题 3：总账号看不到子账号数据

**解决方法**: 确认数据记录中有正确的 creator 字段

### 问题 4：操作记录不显示

**解决方法**: 确认操作日志中间件已正确配置到路由上

## 开发说明

### 添加新的权限控制

如需要为其他页面添加权限控制，请按以下步骤：

1. **后端控制器添加权限过滤**:

```javascript
// 在查询条件中添加权限控制
if (req.user && !req.user.isAdmin()) {
  query.creator = req.user.username;
}
```

2. **路由添加认证中间件**:

```javascript
router.get("/list", optionalAuth, yourController.list);
```

3. **数据创建时添加 creator 字段**:

```javascript
const record = await Model.create({
  ...data,
  creator: req.user ? req.user.username : "anonymous",
});
```

4. **前端添加权限提示**:

```javascript
<Alert
  message={
    currentUser?.role === "admin"
      ? "总账号权限：您可以查看所有记录"
      : "子账号权限：您只能查看自己的记录"
  }
  type={currentUser?.role === "admin" ? "success" : "info"}
  showIcon
  closable
/>
```

## 联系支持

如果您在使用过程中遇到问题或需要技术支持，请提供：

1. 详细的错误描述
2. 操作步骤
3. 浏览器控制台错误信息
4. 服务器日志（如适用）

---

📝 **文档版本**: v1.0  
📅 **更新日期**: 2025 年 9 月  
👨‍💻 **维护者**: FSU 系统开发团队
