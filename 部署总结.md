# Windows Server 2012 R2 部署总结

## 🎯 部署概述

本文档总结了 FSU 设备上线管理系统在 Windows Server 2012 R2 上的完整部署方案，包含自动化脚本和详细操作指南。

## 📋 部署文件清单

### 部署相关文件

```
项目根目录/
├── Windows-Server-2012-R2-部署指南.md    # 详细部署指南
├── deploy-windows-server.bat             # 自动部署脚本
├── configure-iis.bat                     # IIS配置脚本
├── deploy-public-network.bat             # 公网部署配置脚本
├── configure-ssl.bat                     # SSL证书配置脚本
├── system-check.bat                      # 系统检查维护工具
├── 公网部署配置指南.md                   # 公网部署说明
├── 部署总结.md                           # 本文档
├── start.bat                             # 开发环境启动脚本
└── start.sh                              # Linux启动脚本
```

## 🚀 快速部署步骤

### 方式一：内网部署（推荐）

1. **基础部署**

   ```cmd
   # 右键以管理员身份运行
   deploy-windows-server.bat
   ```

2. **配置 IIS**
   ```cmd
   # 安装URL重写模块后运行
   configure-iis.bat
   ```

### 方式二：公网部署

1. **基础部署**

   ```cmd
   # 先完成基础部署
   deploy-windows-server.bat
   ```

2. **公网配置**

   ```cmd
   # 配置公网访问
   deploy-public-network.bat
   ```

3. **SSL 配置** (推荐)

   ```cmd
   # 配置HTTPS访问
   configure-ssl.bat
   ```

4. **验证部署**
   ```cmd
   # 运行系统检查工具
   system-check.bat
   ```

### 方式二：手动部署

详细步骤请参考 `Windows-Server-2012-R2-部署指南.md`

## 🔧 部署脚本功能

### 1. deploy-windows-server.bat（主部署脚本）

**功能：**

- ✅ 检查 Node.js 环境
- ✅ 创建部署目录（C:\FSU-System）
- ✅ 安装项目依赖
- ✅ 配置环境变量
- ✅ 安装 PM2 进程管理器
- ✅ 构建生产版本
- ✅ 配置防火墙规则
- ✅ 启动后端服务
- ✅ 配置自启动

**运行要求：**

- 管理员权限
- 已安装 Node.js 16+

### 2. configure-iis.bat（IIS 配置脚本）

**功能：**

- ✅ 启用 IIS Web 服务器
- ✅ 创建 FSU 网站
- ✅ 配置 URL 重写规则
- ✅ 设置反向代理
- ✅ 配置静态文件服务
- ✅ 启动网站服务

**前置要求：**

- 已运行主部署脚本
- 已安装 URL 重写模块
- 已安装 ARR 模块

### 3. system-check.bat（系统维护工具）

**功能：**

- 🔍 系统状态检查
- 📊 服务状态监控
- 🔄 服务重启管理
- 📁 日志查看和清理
- 🔧 系统诊断
- 📈 性能监控
- 🚀 更新部署

## 🌐 部署架构

```
用户请求
    ↓
IIS (端口80)
    ↓
URL重写/反向代理
    ↓
Node.js后端 (端口3001)
    ↓
SC服务器 (sn-r.toweraiot.cn:8080)
```

### 部署目录结构

```
C:\FSU-System/
├── backend/                    # 后端源码
│   ├── app.js                 # 主应用文件
│   ├── start.js               # 启动文件
│   ├── .env                   # 环境变量配置
│   ├── logs/                  # 应用日志
│   └── node_modules/          # 后端依赖
├── frontend/                   # 前端源码
│   ├── build/                 # 构建输出（IIS指向）
│   │   ├── index.html
│   │   ├── static/
│   │   └── web.config         # IIS配置
│   └── node_modules/          # 前端依赖
├── ecosystem.config.js         # PM2配置文件
└── node_modules/              # 根依赖
```

## 🔧 关键配置

### 环境变量配置（backend/.env）

```env
PORT=3001
SC_HOST=sn-r.toweraiot.cn
SC_PORT=8080
LOG_LEVEL=info
NODE_ENV=production
```

### PM2 配置（ecosystem.config.js）

```javascript
module.exports = {
  apps: [
    {
      name: "fsu-backend",
      script: "./backend/start.js",
      instances: 1,
      autorestart: true,
      max_memory_restart: "1G",
      env: {
        NODE_ENV: "production",
        PORT: 3001,
      },
    },
  ],
};
```

### IIS 配置（web.config）

- API 请求代理到 Node.js 后端
- React 路由支持
- 静态文件服务
- 错误页面处理

## 🔥 防火墙配置

```cmd
# 开放的端口
- HTTP: 80 (入站)
- 后端: 3001 (入站)
- SC服务器: 8080 (出站)
```

## 📊 服务管理

### PM2 命令

```cmd
pm2 status              # 查看服务状态
pm2 logs fsu-backend     # 查看日志
pm2 restart fsu-backend  # 重启服务
pm2 stop fsu-backend     # 停止服务
pm2 monit               # 性能监控
```

### IIS 命令

```cmd
iisreset                           # 重启IIS
appcmd list sites                  # 查看网站
appcmd stop site "FSU-System"      # 停止网站
appcmd start site "FSU-System"     # 启动网站
```

## 🔍 访问地址

部署完成后的访问地址：

### 开发环境

- 前端: http://localhost:3000
- 后端: http://localhost:3001
- 健康检查: http://localhost:3001/api/fsu/health

### 生产环境（IIS 部署）

- 前端: http://服务器 IP/
- 后端 API: http://服务器 IP/api/
- 健康检查: http://服务器 IP/api/fsu/health

## 🔧 常见问题排查

### 1. Node.js 服务无法启动

```cmd
# 检查端口占用
netstat -an | find "3001"

# 查看PM2日志
pm2 logs fsu-backend

# 检查环境变量
type backend\.env
```

### 2. IIS 反向代理不工作

```cmd
# 检查URL重写模块
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\IIS Extensions\URL Rewrite"

# 检查ARR模块
%windir%\system32\inetsrv\appcmd list config -section:system.webServer/proxy

# 查看IIS日志
dir %SystemDrive%\inetpub\logs\LogFiles\W3SVC*\*.log
```

### 3. 无法访问 SC 服务器

```cmd
# 测试网络连通性
ping sn-r.toweraiot.cn
telnet sn-r.toweraiot.cn 8080

# 检查防火墙规则
netsh advfirewall firewall show rule name="SC-Server"
```

## 📈 性能优化建议

### 系统级优化

- 设置足够的 Node.js 内存限制
- 配置 PM2 日志轮转
- 定期清理旧日志文件
- 监控磁盘空间使用

### 应用级优化

- 启用前端资源压缩
- 配置浏览器缓存策略
- 优化数据库查询
- 实施 API 限流机制

## 🔐 安全建议

### 系统安全

- 定期更新 Windows 补丁
- 配置强密码策略
- 限制远程桌面访问
- 启用防火墙和防病毒

### 应用安全

- 使用 HTTPS 协议
- 实施 API 认证机制
- 定期更新依赖包
- 配置安全头信息

### 网络安全

- 配置 VPN 访问专网
- 限制不必要端口开放
- 监控异常访问
- 定期安全审计

## 📋 维护计划

### 日常维护

- 监控服务状态
- 检查日志异常
- 监控系统资源
- 验证业务功能

### 定期维护

- 清理系统日志
- 更新安全补丁
- 备份重要数据
- 性能调优

### 应急处理

- 服务故障恢复
- 数据备份还原
- 安全事件响应
- 容量扩展

## 📞 技术支持

### 日志位置

- 应用日志: `C:\FSU-System\backend\logs\`
- PM2 日志: `C:\Users\<用户>\.pm2\logs\`
- IIS 日志: `%SystemDrive%\inetpub\logs\LogFiles\`

### 配置文件

- 后端配置: `C:\FSU-System\backend\.env`
- PM2 配置: `C:\FSU-System\ecosystem.config.js`
- IIS 配置: `C:\FSU-System\frontend\build\web.config`

### 管理工具

- 系统检查: `system-check.bat`
- 重新部署: `deploy-windows-server.bat`
- IIS 配置: `configure-iis.bat`

## 📝 部署检查清单

### 部署前检查

- [ ] 服务器系统要求满足
- [ ] 网络环境可访问 SC 服务器
- [ ] 具备管理员权限
- [ ] 已安装 Node.js 环境

### 部署过程检查

- [ ] 自动部署脚本执行成功
- [ ] 依赖包安装完成
- [ ] PM2 服务启动正常
- [ ] 前端构建成功

### 部署后验证

- [ ] 后端 API 健康检查通过
- [ ] 前端页面正常访问
- [ ] IIS 反向代理工作正常
- [ ] 防火墙规则配置正确
- [ ] 服务自启动配置成功

### 功能测试

- [ ] 用户注册登录功能
- [ ] FSU 设备注册功能
- [ ] SC 服务器连接测试
- [ ] 日志记录功能

---

**🎉 部署完成！**

现在您的 FSU 设备上线管理系统已经成功部署在 Windows Server 2012 R2 上了。系统将自动启动，用户可以通过浏览器访问 Web 界面进行 FSU 设备管理操作。
