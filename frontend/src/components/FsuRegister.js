import React, { useState, useEffect } from "react";
import {
  Form,
  Input,
  Select,
  Button,
  message,
  Card,
  Table,
  Tag,
  Space,
  Divider,
  Alert,
  Spin,
  Tooltip,
  Row,
  Col,
} from "antd";
import {
  SendOutlined,
  ReloadOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  SyncOutlined,
  InfoCircleOutlined,
  WifiOutlined,
} from "@ant-design/icons";
import { fsuApi, handleApiResponse, handleApiError } from "../services/api";
import dayjs from "dayjs";

const { Option } = Select;
const { TextArea } = Input;

const FsuRegister = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [history, setHistory] = useState([]);
  const [connectionStatus, setConnectionStatus] = useState(null);
  const [testingConnection, setTestingConnection] = useState(false);

  // è®¾å¤‡é€‰é¡¹é…ç½®
  const deviceOptions = [
    { value: "power", label: "é«˜å‹é…ç”µ", icon: "âš¡" },
    { value: "air", label: "ç©ºè°ƒ", icon: "â„ï¸" },
    { value: "battery", label: "è“„ç”µæ± ", icon: "ğŸ”‹" },
  ];

  // ç½‘ç»œç±»å‹é€‰é¡¹
  const networkOptions = [
    { value: "4G", label: "4Gç½‘ç»œ" },
    { value: "5G", label: "5Gç½‘ç»œ" },
    { value: "ETHERNET", label: "æœ‰çº¿ç½‘ç»œ" },
    { value: "WIFI", label: "WiFiç½‘ç»œ" },
  ];

  // ç»„ä»¶æŒ‚è½½æ—¶æµ‹è¯•è¿æ¥
  useEffect(() => {
    testConnection();
  }, []);

  // æµ‹è¯•SCæœåŠ¡å™¨è¿æ¥
  const testConnection = async () => {
    try {
      setTestingConnection(true);
      const response = await fsuApi.testConnection();
      const result = handleApiResponse(response);
      setConnectionStatus({ connected: true, message: result.message });
    } catch (error) {
      const errorMsg = handleApiError(error);
      setConnectionStatus({ connected: false, message: errorMsg });
    } finally {
      setTestingConnection(false);
    }
  };

  // æäº¤FSUæ³¨å†Œè¯·æ±‚
  const handleSubmit = async () => {
    try {
      setLoading(true);

      // è¡¨å•éªŒè¯
      const values = await form.validateFields();

      // æ·»åŠ æ—¶é—´æˆ³å’Œå…¶ä»–ä¿¡æ¯
      const fsuData = {
        ...values,
        submitTime: new Date().toISOString(),
        clientInfo: {
          userAgent: navigator.userAgent,
          timestamp: Date.now(),
        },
      };

      console.log("æäº¤FSUæ³¨å†Œæ•°æ®:", fsuData);

      // è°ƒç”¨åç«¯API
      const response = await fsuApi.register(fsuData);
      const result = handleApiResponse(response);

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      message.success("FSUæ³¨å†Œè¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨å¤„ç†ä¸­...");

      // æ·»åŠ åˆ°å†å²è®°å½•
      const historyItem = {
        key: Date.now(),
        fsuId: values.fsuId,
        fsuCode: values.fsuCode,
        devices: values.devices,
        networkType: values.networkType,
        status: result.success ? "success" : "error",
        message: result.message,
        submitTime: dayjs().format("YYYY-MM-DD HH:mm:ss"),
        processTime: result.processTime,
      };

      setHistory((prev) => [historyItem, ...prev]);

      // å¦‚æœæˆåŠŸï¼Œæ¸…ç©ºè¡¨å•
      if (result.success) {
        form.resetFields();
      }
    } catch (error) {
      const errorMsg = handleApiError(error);
      console.error("FSUæ³¨å†Œå¤±è´¥:", error);

      // æ·»åŠ å¤±è´¥è®°å½•åˆ°å†å²
      const values = form.getFieldsValue();
      const historyItem = {
        key: Date.now(),
        fsuId: values.fsuId || "æœªçŸ¥",
        fsuCode: values.fsuCode || "æœªçŸ¥",
        devices: values.devices || [],
        networkType: values.networkType || "æœªçŸ¥",
        status: "error",
        message: errorMsg,
        submitTime: dayjs().format("YYYY-MM-DD HH:mm:ss"),
        processTime: 0,
      };

      setHistory((prev) => [historyItem, ...prev]);
    } finally {
      setLoading(false);
    }
  };

  // æ¸…ç©ºå†å²è®°å½•
  const clearHistory = () => {
    setHistory([]);
    message.success("å†å²è®°å½•å·²æ¸…ç©º");
  };

  // è¡¨æ ¼åˆ—é…ç½®
  const columns = [
    {
      title: "FSU ID",
      dataIndex: "fsuId",
      key: "fsuId",
      width: 120,
    },
    {
      title: "FSUç¼–ç ",
      dataIndex: "fsuCode",
      key: "fsuCode",
      width: 160,
      ellipsis: true,
    },
    {
      title: "è®¾å¤‡åˆ—è¡¨",
      dataIndex: "devices",
      key: "devices",
      width: 200,
      render: (devices) => (
        <Space wrap>
          {devices.map((device) => {
            const option = deviceOptions.find((opt) => opt.value === device);
            return (
              <Tag key={device} color="blue">
                {option?.icon} {option?.label || device}
              </Tag>
            );
          })}
        </Space>
      ),
    },
    {
      title: "ç½‘ç»œç±»å‹",
      dataIndex: "networkType",
      key: "networkType",
      width: 100,
      render: (type) => <Tag color="green">{type}</Tag>,
    },
    {
      title: "çŠ¶æ€",
      dataIndex: "status",
      key: "status",
      width: 100,
      render: (status, record) => {
        const statusConfig = {
          success: {
            color: "success",
            icon: <CheckCircleOutlined />,
            text: "æˆåŠŸ",
          },
          error: {
            color: "error",
            icon: <CloseCircleOutlined />,
            text: "å¤±è´¥",
          },
          processing: {
            color: "processing",
            icon: <SyncOutlined spin />,
            text: "å¤„ç†ä¸­",
          },
        };

        const config = statusConfig[status] || statusConfig.processing;

        return (
          <Tooltip title={record.message}>
            <Tag color={config.color} icon={config.icon}>
              {config.text}
            </Tag>
          </Tooltip>
        );
      },
    },
    {
      title: "æäº¤æ—¶é—´",
      dataIndex: "submitTime",
      key: "submitTime",
      width: 160,
    },
    {
      title: "å¤„ç†è€—æ—¶",
      dataIndex: "processTime",
      key: "processTime",
      width: 100,
      render: (time) => (time ? `${time}ms` : "-"),
    },
  ];

  return (
    <div className="fsu-register">
      {/* è¿æ¥çŠ¶æ€æç¤º */}
      <Card className="connection-card" style={{ marginBottom: 24 }}>
        <Row align="middle" justify="space-between">
          <Col>
            <Space>
              <WifiOutlined />
              <span>SCæœåŠ¡å™¨è¿æ¥çŠ¶æ€:</span>
              {testingConnection ? (
                <Spin size="small" />
              ) : connectionStatus ? (
                <Tag
                  color={connectionStatus.connected ? "success" : "error"}
                  icon={
                    connectionStatus.connected ? (
                      <CheckCircleOutlined />
                    ) : (
                      <CloseCircleOutlined />
                    )
                  }
                >
                  {connectionStatus.connected ? "å·²è¿æ¥" : "è¿æ¥å¤±è´¥"}
                </Tag>
              ) : (
                <Tag color="default">æœªçŸ¥</Tag>
              )}
              {connectionStatus && (
                <span style={{ color: "#666", fontSize: "12px" }}>
                  {connectionStatus.message}
                </span>
              )}
            </Space>
          </Col>
          <Col>
            <Button
              size="small"
              icon={<ReloadOutlined />}
              onClick={testConnection}
              loading={testingConnection}
            >
              é‡æ–°æµ‹è¯•
            </Button>
          </Col>
        </Row>
      </Card>

      {/* FSUæ³¨å†Œè¡¨å• */}
      <Card
        title={
          <Space>
            <SendOutlined />
            FSUè®¾å¤‡æ³¨å†Œ
          </Space>
        }
        className="form-card"
      >
        <Form
          form={form}
          layout="vertical"
          initialValues={{
            networkType: "4G",
            softwareVersion: "V1.0.0",
          }}
          onFinish={handleSubmit}
        >
          <Row gutter={24}>
            <Col xs={24} sm={12} md={8}>
              <Form.Item
                name="fsuId"
                label={
                  <Space>
                    FSU ID
                    <Tooltip title="FSUè®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œ10-20ä½æ•°å­—">
                      <InfoCircleOutlined style={{ color: "#999" }} />
                    </Tooltip>
                  </Space>
                }
                rules={[
                  { required: true, message: "è¯·è¾“å…¥FSU ID" },
                  { pattern: /^\d{10,20}$/, message: "è¯·è¾“å…¥10-20ä½æ•°å­—" },
                ]}
              >
                <Input placeholder="ä¾‹å¦‚ï¼š10024" maxLength={20} showCount />
              </Form.Item>
            </Col>

            <Col xs={24} sm={12} md={8}>
              <Form.Item
                name="fsuCode"
                label={
                  <Space>
                    FSUç¼–ç 
                    <Tooltip title="FSUè®¾å¤‡ç¼–ç ï¼Œå¿…é¡»ä¸º14ä½å­—ç¬¦">
                      <InfoCircleOutlined style={{ color: "#999" }} />
                    </Tooltip>
                  </Space>
                }
                rules={[
                  { required: true, message: "è¯·è¾“å…¥FSUç¼–ç " },
                  { len: 14, message: "FSUç¼–ç å¿…é¡»ä¸º14ä½å­—ç¬¦" },
                ]}
              >
                <Input
                  placeholder="ä¾‹å¦‚ï¼š11010110100001"
                  maxLength={14}
                  showCount
                />
              </Form.Item>
            </Col>

            <Col xs={24} sm={12} md={8}>
              <Form.Item name="networkType" label="ç½‘ç»œç±»å‹">
                <Select placeholder="è¯·é€‰æ‹©ç½‘ç»œç±»å‹">
                  {networkOptions.map((option) => (
                    <Option key={option.value} value={option.value}>
                      {option.label}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={24}>
            <Col xs={24} md={12}>
              <Form.Item
                name="devices"
                label={
                  <Space>
                    è®¾å¤‡åˆ—è¡¨
                    <Tooltip title="é€‰æ‹©FSUç›‘æ§çš„è®¾å¤‡ç±»å‹ï¼Œè‡³å°‘é€‰æ‹©ä¸€ä¸ª">
                      <InfoCircleOutlined style={{ color: "#999" }} />
                    </Tooltip>
                  </Space>
                }
                rules={[
                  { required: true, message: "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¾å¤‡" },
                  { type: "array", min: 1, message: "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¾å¤‡" },
                ]}
              >
                <Select
                  mode="multiple"
                  placeholder="è¯·é€‰æ‹©ç›‘æ§è®¾å¤‡"
                  optionLabelProp="label"
                >
                  {deviceOptions.map((option) => (
                    <Option
                      key={option.value}
                      value={option.value}
                      label={`${option.icon} ${option.label}`}
                    >
                      <Space>
                        <span>{option.icon}</span>
                        <span>{option.label}</span>
                      </Space>
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>

            <Col xs={24} md={12}>
              <Form.Item name="softwareVersion" label="è½¯ä»¶ç‰ˆæœ¬">
                <Input placeholder="ä¾‹å¦‚ï¼šV2.3.5" />
              </Form.Item>
            </Col>
          </Row>

          <Form.Item name="remark" label="å¤‡æ³¨">
            <TextArea
              placeholder="å¯é€‰ï¼Œå¡«å†™å¤‡æ³¨ä¿¡æ¯"
              rows={3}
              maxLength={200}
              showCount
            />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button
                type="primary"
                htmlType="submit"
                loading={loading}
                icon={<SendOutlined />}
                size="large"
                disabled={!connectionStatus?.connected}
              >
                {loading ? "æ­£åœ¨æ³¨å†Œ..." : "å‘èµ·æ³¨å†Œè¯·æ±‚"}
              </Button>

              <Button onClick={() => form.resetFields()} disabled={loading}>
                é‡ç½®è¡¨å•
              </Button>
            </Space>
          </Form.Item>
        </Form>

        {!connectionStatus?.connected && (
          <Alert
            message="SCæœåŠ¡å™¨è¿æ¥å¼‚å¸¸"
            description="è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜"
            type="warning"
            showIcon
            style={{ marginTop: 16 }}
          />
        )}
      </Card>

      <Divider />

      {/* å†å²è®°å½• */}
      <Card
        title={
          <Space>
            <InfoCircleOutlined />
            æ³¨å†Œå†å²è®°å½•
          </Space>
        }
        extra={
          <Space>
            <Button
              size="small"
              onClick={clearHistory}
              disabled={history.length === 0}
            >
              æ¸…ç©ºè®°å½•
            </Button>
          </Space>
        }
        className="history-card"
      >
        <Table
          dataSource={history}
          columns={columns}
          pagination={{
            pageSize: 10,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `å…± ${total} æ¡è®°å½•`,
          }}
          scroll={{ x: 1000 }}
          locale={{
            emptyText: "æš‚æ— æ³¨å†Œè®°å½•",
          }}
        />
      </Card>
    </div>
  );
};

export default FsuRegister;
